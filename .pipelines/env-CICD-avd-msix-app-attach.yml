# root MSIX AppAttach Multi-stage pipeline (CI & CD)
# Requires resources: Storage, AVD Session Pool, Variable group named Secrets with containing the CertificatePassword variable
# Required parameters to set: fileLocation, fileName, version
# Required variables (or variable group): msixAppAttachUNCLocalPath, msixAppAttachUNCServer, msixAppAttachShareName, UserName, UserPassword

trigger:
- none

parameters:
- name: fileLocation # The file location path. Expected to be reachacble through http/https protocol for direct download.
  displayName: Configured App Path
  type: string
  default: https://wvdsdevstrg.blob.core.windows.net/syncier-sac
- name: fileName # The app file name for a particular app release
  displayName: Configured App File Name
  type: string
  default: syncier-abscs-configured.zip
- name: version # The application version (semantic version is recommended) to be used in the AVD deployment
  displayName: Application Version
  type: string
  default: "0.0.6.0"

variables:
# Use the psf* variables to active the PSF scenario - default is disabled
- name: psfEnabled # Set to true to enable the PSF support sample
  value: false
- name: psfExecutable # Change this if you need a 32Bit PSF launcher
  value: PSFLauncher64.exe

# Application specific variable group
- group: APP-msix-appattach-vg

# The application name to be used in the AVD deployment
# - name: applicationName
#   value: SimpleApp
# The application display name to be used in the MSIX package to be deployed in the AVD environment.
# - name: applicationDisplayName
#   value: Simple App
# The application description to be used in the MSIX package to be deployed in the AVD environment.
# - name: applicationDescription 
#   value: SimpleApp
# The application full executable path in the in the MSIX package. Corresponds to the main application entrypoint.
# - name: applicationExecutable 
#   value: simple-app.exe
# The MSIX Package certificate publisher. Typically follows the syntax "CN=Contoso Software, O=Contoso Corporation, C=US".
# - name: publisher 
#   value: CN=Contoso
# The MSIX Package certificate publisher display name.
# - name: publisherDisplayName 
#   value: Contoso
# The maximum MSIX image size to be used in the VHD/CIM image format. Must be enough to include full application and its dependencies.
# - name: msixImageSize 
#   value: 100
# The certificate file name to sign the MSIX Package.
# - name: CertificateName 
#   value: sscert.pfx
# The Name of the variable [CertificatePassword] referencing the secure variable containing the password used by MsixSigning@1
# - name: CertificatePasswordVariable 
#   value: CertificatePassword
# The certificate password
# - name: CertificatePassword 
#   value: *******

## Environment specific variables
- group: DEV-msix-appattach-vg

# An ID provided to identify the environment. Typically 'Dev, Qa, Staging, Prod'.
# - name: environmentId
#   value: DEV
# The name of a Service Connection of type Azure Resource Manager in the Azure Devops organization. It will provide access to storage accounts, Virtual Machines, AVD or any other azure resource.
# - name: azureSubscription
#   value: <ado-azure-rm-connection-service>
# The resource group where the Azure Virtual Desktop resource are created (session pool, application groups and/or workspace).
# - name: resourceGroup 
#   value: <azure resource group>
# The storage account where the CI_App_base will be copied from and used by the AzureCopyTask@4
# - name: storageAccount 
#   value: <azure storage account>
# The session host pool resource name in the Azure Virtual Desktop infrastructure.
# - name: hostPoolName 
#   value: <azure virtual desktop session host pool name>
# Name of the Azure VM admin/domain User
# - name: UserName
#   value: ******
# Password of the Azure VM/domain User
# - name: UserPassword
#   value: ******
# The Azure VM local path, where the UNC Share is configured. The MSIX Image will be copied using local filesystem (PSSession) and made available through the configured file share.
# - name: msixAzureVMLocalPath
#   value: c:\Contoso\MSIX
# The UNC Server FQDN used to place the MSIX App Attach image and execute AVD app registration. It is used with variable msixAppAttachShareName
# - name: msixAppAttachUNCServer
#   value: fileshare.domain.onmicrosoft.com
# The UNC Share name used to place the MSIX App Attach image and execute AVD app registration. It is used with variable msixAppAttachUNCServer
# - name: msixAppAttachShareName
#   value: avdmsix

# Secrets variable group (if you chose to bind to Keyvault)
#- group: Secrets-msix-appattach-vg 

stages:

- template: templates/CI-msix-stage.yaml
  parameters: 
    fileLocation: ${{ parameters.fileLocation }}
    fileName: ${{ parameters.fileName }}
    applicationName: $(applicationName)
    applicationExecutable: $(applicationExecutable)
    msixVersion: ${{ parameters.version }}
    msixImageSize:  ($(msixImageSize))
    msixImageFileName: $(applicationName)-msix-image-${{ parameters.version }}.vhdx
    msixApplicationUNCPath: '\\$(msixAppAttachUNCServer)\$(msixAppAttachShareName)'
    applicationDisplayName: $(applicationDisplayName)
    applicationDescription: $(applicationDescription)
    publisher: $(publisher)
    publisherDisplayName: $(publisherDisplayName)
    psfEnabled: $(psfEnabled)
    psfExecutable: $(psfExecutable)
    CertificateName: $(CertificateName)
    CertificatePasswordVariable: $(CertificatePasswordVariable) # From variable group

- template: templates/CD-msix-stage.yaml
  parameters:
    envId: $(environmentId)
    azureSubscription: $(azureSubscription)
    resourceGroup: $(resourceGroup)
    storageAccount: $(storageAccount)
    hostPoolName: $(hostPoolName)
    applicationName: $(applicationName)
    msixVersion: ${{ parameters.version }}
    msixImageFileName: $(applicationName)-msix-image-${{ parameters.version }}.vhdx
    msixAppAttachUNCServer: $(msixAppAttachUNCServer)
    msixAppAttachShareName: $(msixAppAttachShareName)
    msixAzureVMLocalPath: $(msixAzureVMLocalPath)
    UserName: $(UserName)
    UserPassword: (UserPassword)

